# Silent Council - 讨价还价机制强化说明

## 📋 改进目标

确保4个AI代理之间进行真实的讨价还价对话，而不是单方面发牢骚。每个AI必须针对具体任务和资源数字进行交易谈判。

---

## ✅ 已实施的改进

### 1. **强化Prompt指令** (`src/lib/council/prompts.ts`)

#### 新增讨价还价示例库
为每个AI角色添加了具体的对话示例，展示正确的讨价还价模式：

**ENTJ（效率之神）示例：**
- "我把'写代码'升级到A级要200Token。ESTP,你把'刷短视频'降到C级给我100Token，我分你50Token做应急储备。"

**ISFJ（守护者）示例：**
- "ENTJ，你想压缩睡眠到6小时？不行！除非你答应'代码审查'从A降到B，省的Token给我买健康食谱。"

**INFJ（外交家）示例：**
- "ENTJ，你整天都是工作任务，这样活着有意义吗？我要否决'加班做表格'，除非加一个'给朋友写信'的任务。"

**ESTP（探险家）示例：**
- "ESTP要做'旅游攻略Level A'？可以，但你得把明天节省的50Token存到应急金里。"

#### 明确禁止规则
在Prompt中添加了明确的禁止项：

❌ **禁止的发言（纯发牢骚）：**
- "Token太少了，根本不够用！"（没有提出解决方案）
- "这个任务太浪费了。"（没有说要怎么办）
- "我不同意。"（没有说为什么，也没有反提案）

✅ **要求的发言（讨价还价）：**
- 必须针对具体任务提出明确的资源要求或交易条件
- 必须回应其他AI的提议，说"同意"或"不同意"，并给出条件
- 必须主动向其他AI提出交换条件（"我让你xxx，你给我xxx"）
- 每次发言都要推进博弈进程

#### 增强行动类型说明
为每种intent类型添加了更详细的要求：
- **BID**: 必须说明投入多少Token在哪个具体任务上
- **ATTACK**: 必须同时提出替代方案
- **TRADE**: 必须说清楚双方的交换内容（具体数字）
- **PROPOSE**: 必须包含具体的资源分配数字
- **VETO**: 必须说明要求的妥协条件
- **COUNTER**: 必须说明反提案是什么

---

### 2. **实现验证机制** (`src/lib/council/prompts.ts`)

新增 `isValidNegotiation()` 函数，自动检测AI发言是否包含有效的讨价还价内容：

```typescript
export function isValidNegotiation(speech: string, intent: string): { 
  valid: boolean; 
  reason?: string 
}
```

**检测逻辑：**
- ✅ 行动类型intent（bid, trade, propose等）自动通过
- ✅ 包含数字、等级、条件关键词的发言通过
- ❌ 纯发牢骚的特征词（"太少"、"根本不够"、"我不同意"）被拒绝

---

### 3. **集成到议会流程** (`src/lib/council/orchestrator.ts`)

在 `processAgentOutput()` 函数中添加验证逻辑：

```typescript
// 验证是否为有效的讨价还价
const validation = isValidNegotiation(output.public_speech, output.internal_state.intent);
if (!validation.valid) {
  // 发牢骚被拒绝，记录警告
  const warningLog = session.addLog({
    agentId: null,
    type: 'SYSTEM',
    content: `⚠️ ${AGENT_DEFINITIONS[speaker].icon} 的发言被系统拒绝: ${validation.reason}`,
  });
  config.onLog?.(warningLog);
  
  // 惩罚：降低该代理的满意度
  session.updateAgentState(speaker, {
    satisfaction: Math.max(0, currentState.satisfaction - 10),
  });
  return; // 不处理这条消息
}
```

**效果：**
- 纯发牢骚的消息会被系统拒绝
- 发牢骚的AI满意度会下降10点（惩罚机制）
- 用户会看到系统警告

---

### 4. **更新设计文档** (`议会设计.md`)

#### 新增章节 §2.5：AI对话核心规则

详细说明了讨价还价的要求，包括：
- 必须包含的内容（资源要求/交易提案/回应/反提案）
- 正确vs错误的对话示例对比
- 系统强制要求

#### 重写博弈示例 §4

将原来的简略示例扩展为完整的对话流程，展示4个AI如何通过多轮讨价还价达成最终方案：

**原示例（简略）：**
- 只有几句总结性的描述
- 缺少具体的对话过程

**新示例（详细）：**
- 包含完整的多轮对话
- 每个AI都有明确的提案、反提案、妥协
- 展示了从初始方案→争执→交易→妥协→达成共识的完整过程
- 最终给出博弈结果分析（每个AI赢得了什么）

#### 更新游戏玩法说明

在"开始议会博弈过程"部分强调：
- AI必须真实地讨价还价，而不是发牢骚
- 给出对话示例风格的对比
- 说明系统会自动拒绝纯发牢骚的发言

---

## 🎯 改进效果

### 对话质量提升
- ❌ 改进前：AI可能只是抱怨"Token不够"、"这不合理"
- ✅ 改进后：AI必须说"我要X个Token做Y任务，你给我Z我就支持你"

### 博弈感增强
- 每条消息都推进博弈进程
- AI之间有明确的交换和妥协
- 用户能看到真实的谈判过程

### 系统约束
- 自动检测和拒绝无效发言
- 对发牢骚的AI进行惩罚
- 确保对话质量

---

## 📖 使用示例

### 正确的对话流程

```
🎯 ENTJ: "我的方案：机票50Token做Level B，PPT 100Token Level B。剩余350Token储备。"

🎲 ESTP: "不行！美食视频不做？我要C升级到Level A投入300Token！ENTJ你的PPT降到Level C省50给我。"

🎯 ENTJ: "降到Level C？PPT质量太差。除非你用私房钱补贴我的机票升到Level A，积累我的KPI成就。"

🎲 ESTP: "可以，我用100私房钱升级你机票。但你PPT必须降到Level C省50。成交？"

🛡️ ISFJ: "等等！这样Token池只剩100，任务D怎么办？ESTP的应急储备也没了很危险。"

💫 INFJ: "我支持ESTP做美食视频，但Level B（150Token）就够了。ENTJ方案全是工作，用户会枯燥。"

🎯 ENTJ: "Level B妥协可以。重新算：PPT保持Level B 100Token，机票Level A 100Token（我50+ESTP私房钱50），美食视频Level B 150Token，代码Level C 30Token。总计380，还剩120储备。ISFJ满意吗？"

🛡️ ISFJ: "ESTP只用50私房钱可以接受，任务D保留，120储备够了。同意！"

💫 INFJ: "平衡工作和娱乐。同意。"

🎲 ESTP: "虽然只Level B但至少能做。我只花50私房钱。成交！"
```

### 系统会拒绝的发言

```
❌ ESTP: "Token太少了！根本不够用！"
→ 系统: "⚠️ 🎲 的发言被系统拒绝: 发言缺乏具体行动，请提出明确的交易条件、资源要求或反提案"

❌ ISFJ: "这个任务太浪费了。"
→ 系统: "⚠️ 🛡️ 的发言被系统拒绝: 发言缺乏具体行动，请提出明确的交易条件、资源要求或反提案"

❌ INFJ: "我不同意。"
→ 系统: "⚠️ 💫 的发言被系统拒绝: 发言缺乏具体行动，请提出明确的交易条件、资源要求或反提案"
```

---

## 🔄 后续优化建议

1. **增强验证逻辑**
   - 可以添加更多的模式识别
   - 检测是否真的在回应其他AI的提案

2. **动态调整**
   - 根据博弈进度调整要求的严格程度
   - 后期可以允许更简洁的回应

3. **奖励机制**
   - 对提出优质交易提案的AI给予奖励
   - 提升完成成功交易的AI的满意度

4. **学习优化**
   - 收集被拒绝的发言数据
   - 持续优化Prompt示例

---

## 📝 总结

通过这次改进，Silent Council的AI对话将从"各说各话的发牢骚"转变为"真实的讨价还价谈判"。每个AI都必须用具体的数字、任务名和交换条件来说服对手，让博弈过程更加真实、紧张、有趣。
